#Ğ›Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°: AR(p)ARCH(q) Ğ¸ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
#Ğ ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ğ´ğ‘…(2)ğ´ğ‘…ğ¶ğ»(3) Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ¸Ğ· ğ‘› = 2100 Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğ¹ Ñ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² ğœƒ = (âˆ’0.3, 0.4)â€², ğ´ = (1, 0.2, 0.1, 0.2)â€² Ğ¸ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ ĞµĞ³Ğ¾ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº.
#library(stats)
set.seed(123)
library("tseries")
n = 2100
n_2 = 2000
n_3 = 100
Teta = c(-0.3, 0.4)
A = c(1, 0.2, 0.1, 0.2)
#par(mfrow = c(2, 1))
#ar_2 = arima.sim(n=2100, list(order=c(2,0,0), ar=Teta))
#plot(ar_2, type='l', main = "Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº ÑÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° AR(2)ARCH(3)")

AR2_CH3 = function(n,a,Teta,ret)
{x = array(dim = n)
 s = array(dim = n)
 E = rnorm(n,0,1)
 s[1]=A[1]
 x[1]=sqrt(s[1])*E[1] 
 s[2]=A[1]+A[2]*x[1]^2
 x[2]=sqrt(s[2])*E[2]+Teta[1]*x[1]
 s[3]=A[1]+A[2]*x[2]^2+ A[3]*x[1]^2 
 x[3]=sqrt(s[3])*E[3]+Teta[1]*x[2]+Teta[2]*x[1]
   
 for (i in 4:n) 
   {s[i] = a[1] + a[2]*x[i-1]^2 + a[3]*x[i-2]^2 + a[4]*x[i-3]^2
    x[i] = Teta[1]*x[i-1]+Teta[2]*x[i-2] + sqrt(s[i])*E[i]}
 if (ret==1) return(x) else return(sqrt(s))
}
AR_2 = AR2_CH3(n,A,Teta,1)
plot(AR_2, type = 'l', col = 'purple', main = "Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº ÑÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ñ€Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ° AR(2)ARCH(3)")

#Ğ Ğ°Ğ·Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒ, Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ½ÑƒÑ Ğ½Ğ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ ÑˆĞ°Ğ³Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ {ğ‘¥ğ‘›}, Ğ² Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğ¸ 20:1 Ğ½Ğ° Ğ¾Ğ±ÑƒÑ‡Ğ°ÑÑ‰ÑƒÑ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ¸
x_ob = AR_2[1 : n_2] 
x_test = AR_2[(n_2 + 1) : n]
ar_model = arima(x_ob, order = c(2, 0, 0), include.mean = FALSE)
Teta_1 = c(ar_model$coef[1], ar_model$coef[2])
h = array(dim = n_2)
h[1] = x_ob[1]
h[2] = x_ob[2] - Teta_1[1]*x_ob[1]
for (i in 3 : n_2) {h[i] = x_ob[i] - Teta_1[1]*x_ob[i-1] - Teta_1[2]*x_ob[i-2]}
Gar = garch(h, order = c(3, 0), start = A) # Ğ´Ğ»Ñ Ğ¾Ñ†ĞµĞ½Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ° ğ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ğ‘”ğ‘ğ‘Ÿğ‘â„() Ğ¿Ğ¾ Ğ½ĞµĞ²ÑĞ·ĞºĞ°Ğ¼ {â„Ë†ğ‘›}
A_1 = c(Gar$coef[1], Gar$coef[2], Gar$coef[3], Gar$coef[4])

#Ğ Ğ°Ğ·Ğ±Ğ¸ĞµĞ½Ğ¸Ğµ Ğ½Ğ° Ğ¾Ğ±ÑƒÑ‡Ğ°ÑÑ‰ÑƒÑ Ğ¸ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ¸
#ĞĞ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ Ğ¾Ğ±ÑƒÑ‡Ğ°ÑÑ‰ĞµĞ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾Ñ†ĞµĞ½ĞºĞ¸ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² ğœƒ Ğ¸ ğ´
library(rugarch)
train_size = round(length(AR_2))
train_data = AR_2[1:train_size]
test_data = AR_2[(train_size+1):length(AR_2)]
ar_model1 <- arima(train_data, order=c(2,0,0), method="ML")
Teta_11 = c(ar_model1$coef[1], ar_model1$coef[2])

A_1;Teta_1;Teta_11

#ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ² Ğ½Ğ° Ğ¾Ğ´Ğ¸Ğ½ ÑˆĞ°Ğ³ Ğ½Ğ° Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ²Ñ‹Ğ±Ğ¾Ñ€ĞºĞµ. 
#ĞĞ°Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ² Ğ½Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ°
PR = function(x_test, Teta, a) 
{ x1 = array(dim = n_3)
  s = array(dim = n_3)
  lim_1 = array(dim = n_3) 
  lim_2 = array(dim = n_3)
  x1[1] = 0
  x1[2] = Teta[1]*x_test[1]
  x1[3] = Teta[1]*x_test[2] + Teta[2]*x_test[1]
  s[1] = a[1]
  s[2] = a[1] + a[2]*x_test[1]^2
  s[3] = a[1] + a[2]*x_test[2]^2 + a[3]*x_test[1]^2
  for(i in 4 : n_3) 
  {
    x1[i] = Teta[1]*x_test[i-1] + Teta[2]*x_test[i-2]
    s[i] = a[1] + a[2]*x_test[i-1]^2 + a[3]*x_test[i-2]^2 + a[4]*x_test[i-3]^2
  } 
  for(i in 1 : n_3) # Ñ€Ğ°ÑÑÑ‡ĞµÑ‚ Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†
  {lim_1[i] = x1[i] + sqrt(s[i])
   lim_2[i] = x1[i] - sqrt(s[i])
  }
  plot(x_test, type = 'l',lwd = 2, col = 'turquoise', main = "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ² Ğ¸ Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğ¹")
  lines(x1, type = 'p', pch = 21, cex = 1,lwd = 2, col = 'black') 
  lines(lim_1, lty = 2, lwd = 2,col = 'red')
  lines(lim_2, lty = 2,lwd = 2, col = 'red')
}
plot(x_test, type = 'l',lwd = 2, col = 'turquoise', main = "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ² Ğ¸ Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğ¹")
PR1 = PR(x_test, Teta, A_1) 
legend("bottomright", legend = c("Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Ğ½Ğ° 1 ÑˆĞ°Ğ³", "Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ° Ğ½Ğ¸Ğ· Ğ¸ Ğ²ĞµÑ€Ñ…","Xn"),lwd = 3, col = c("black", "red","turquoise"))

# 5.Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ»ÑĞ±Ñ‹Ğµ Ğ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ ĞºĞ¾Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ñ… Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¾Ğ² Ğ¸Ğ»Ğ¸ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ğ´ĞµĞºÑĞ¾Ğ² (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ·Ğ° 3 Ğ³Ğ¾Ğ´Ğ°).
# 6.Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞºĞ°Ñ‡Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² ğ‘…, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ğ‘Ÿğ‘’ğ‘ğ‘‘.ğ‘¡ğ‘ğ‘ğ‘™ğ‘’()
# 7.ĞŸĞ¾ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ³Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°
#Ğ˜Ğ½Ğ´ĞµĞºÑ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°
par(mfrow = c(2, 1))
table = read.csv( "C:/Users/Admin/Desktop/7 ÑĞµĞ¼ĞµÑÑ‚Ñ€/Ğ­ĞœĞœ - 2/Ğ›Ğ°Ğ±Ğ¾Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğµ/MOEXTN_210118_240118.csv", sep = ";") 
str(table)
print(table)
N=nrow(table);N
activ = table$X.OPEN
plot(activ, type = 'l', main = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°") 
activ1 = table$X.CLOSE
plot(activ1, type = 'l', main = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¸Ğ½Ğ°Ğ¼Ğ¸ĞºĞ¸ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°") 

#ĞŸÑ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğº ÑÑ‚Ğ°Ñ†Ğ¸Ğ¾Ğ½Ğ°Ñ€Ğ½Ğ¾Ğ¼Ñƒ Ğ²Ğ¸Ğ´Ñƒ, Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ Ğ¾Ğ´Ğ½Ğ¾ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
z = array(dim =N)
z[1] = 0
for(k in 2 : N){z[k] = log(activ[k]/activ[k - 1])}
plot(z, type = 'l', main = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚ĞµĞ¹ {ğ‘§ğ‘˜} Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°")

z1 = array(N)
z1[1] = 0
for(k1 in 2 : N)
  z1[k1] = (activ[k1] - activ[k1 - 1])/activ[k1 - 1]
plot(z1, type = 'l', main = "Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ´Ğ¾Ñ…Ğ¾Ğ´Ğ½Ğ¾ÑÑ‚ĞµĞ¹ {ğ‘§ğ‘˜} Ñ„Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°",col = 'turquoise')

#ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ ÑˆĞ°Ğ³Ğ¸ 2-4 Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ {ğ‘§ğ‘›} Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸,Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ {ğ‘§ğ‘›} Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒÑ ğ´ğ‘…(2)ğ´ğ‘…ğ¶ğ»(3).
N
n2 = 6552;n2
n3 = 328; n3
x2_ob = z[1 : n2]
x2_test = z[(n2+1) : N]

ar_model_2 = arima(x2_ob, order = c(2, 0, 0), include.mean = FALSE) # Ğ´Ğ»Ñ Ğ¾Ñ†ĞµĞ½Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ ğœƒ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ğ‘ğ‘Ÿğ‘–ğ‘šğ‘()
Teta_2 = c(ar_model_2$coef[1], ar_model_2$coef[2]); Teta_2

h2 = array(dim = n2)
h2[1] = x2_ob[1]
h2[2] = x2_ob[2] - Teta_2[1]*x2_ob[1]
for (i in 3 : n2) {h2[i] = x2_ob[i] - Teta_2[1]*x2_ob[i-1] - Teta_2[2]*x2_ob[i-2]}
Gar_2 = garch(h2, order = c(3, 0)) # Ğ´Ğ»Ñ Ğ¾Ñ†ĞµĞ½Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ° ğ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ğ‘”ğ‘ğ‘Ÿğ‘â„() Ğ¿Ğ¾ Ğ½ĞµĞ²ÑĞ·ĞºĞ°Ğ¼ {â„Ë†ğ‘›}
A_2 = c(Gar_2$coef[1], Gar_2$coef[2], Gar_2$coef[3], Gar_2$coef[4]); A_2

plot(x2_test, type = 'l', col = 'turquoise', main = "ĞŸĞ¾ÑĞ»ĞµĞ´Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¾Ğ² Ğ¸ Ğ½Ğ°Ğ±Ğ»ÑĞ´ĞµĞ½Ğ¸Ğ¹")
PR2 = PR(x2_test, Teta_2, A_2) 




